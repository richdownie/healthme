<div class="container">
  <header class="app-header">
    <h1>HealthMe</h1>
    <p class="tagline">Your daily health tracker</p>
  </header>

  <nav class="date-nav">
    <%= link_to "← Prev", activities_path(date: @date - 1.day), class: "btn btn-outline" %>
    <div class="date-display">
      <h2><%= @date == Date.today ? "Today" : @date.strftime("%A") %></h2>
      <span class="date-full"><%= @date.strftime("%B %-d, %Y") %></span>
    </div>
    <%= link_to "Next →", activities_path(date: @date + 1.day), class: "btn btn-outline" %>
  </nav>

  <% if notice.present? %>
    <div class="flash-notice"><%= notice %></div>
  <% end %>

  <% total_burned = @calories_burned + (@recommendations ? @recommendations[:daily_burn] : 0) %>
  <% total_net = @calories_in - total_burned %>

  <div class="calorie-summary">
    <div class="calorie-card calorie-in">
      <span class="calorie-label">Consumed</span>
      <span class="calorie-number"><%= number_with_delimiter(@calories_in) %></span>
      <span class="calorie-unit">cal</span>
    </div>
    <div class="calorie-card calorie-out">
      <span class="calorie-label">Burned</span>
      <span class="calorie-number"><%= number_with_delimiter(total_burned) %></span>
      <span class="calorie-unit">cal</span>
      <% if @recommendations %>
        <span class="calorie-breakdown"><%= number_with_delimiter(@recommendations[:daily_burn]) %> base + <%= @calories_burned %> exercise</span>
      <% end %>
    </div>
    <div class="calorie-card calorie-net <%= total_net >= 0 ? 'calorie-positive' : 'calorie-negative' %>">
      <span class="calorie-label">Net</span>
      <span class="calorie-number"><%= total_net >= 0 ? "+" : "" %><%= number_with_delimiter(total_net) %></span>
      <span class="calorie-unit">cal</span>
    </div>
  </div>

  <% if @recommendations %>
    <div class="daily-targets">
      <div class="target-row">
        <span class="target-label">Calories</span>
        <div class="target-progress">
          <div class="target-bar" style="width: <%= [(@calories_in.to_f / @recommendations[:daily_calories] * 100), 100].min %>%"></div>
        </div>
        <span class="target-numbers"><%= @calories_in %> / <%= number_with_delimiter(@recommendations[:daily_calories]) %></span>
      </div>
      <% exercise_goal = @recommendations[:activity_burn].to_f %>
      <% walk_cal = @activities.where(category: "walk").sum(:calories) %>
      <% run_cal = @activities.where(category: "run").sum(:calories) %>
      <% weights_cal = @activities.where(category: "weights").sum(:calories) %>
      <% yoga_cal = @activities.where(category: "yoga").sum(:calories) %>
      <div class="target-row">
        <span class="target-label">Exercise</span>
        <div class="target-progress target-stacked">
          <% if exercise_goal > 0 %>
            <div class="target-segment segment-walk" style="width: <%= [(walk_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-run" style="width: <%= [(run_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-weights" style="width: <%= [(weights_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-yoga" style="width: <%= [(yoga_cal / exercise_goal * 100), 100].min %>%"></div>
          <% end %>
        </div>
        <span class="target-numbers"><%= @calories_burned %> / <%= number_with_delimiter(@recommendations[:activity_burn]) %> cal</span>
      </div>
      <% if @calories_burned > 0 %>
        <div class="exercise-legend">
          <% if walk_cal > 0 %><span class="legend-item"><span class="legend-dot legend-walk"></span>Walk <%= walk_cal %></span><% end %>
          <% if run_cal > 0 %><span class="legend-item"><span class="legend-dot legend-run"></span>Run <%= run_cal %></span><% end %>
          <% if weights_cal > 0 %><span class="legend-item"><span class="legend-dot legend-weights"></span>Weights <%= weights_cal %></span><% end %>
          <% if yoga_cal > 0 %><span class="legend-item"><span class="legend-dot legend-yoga"></span>Yoga <%= yoga_cal %></span><% end %>
        </div>
      <% end %>
      <% water_today = @activities.where(category: "water").sum(:value) %>
      <% water_goal = current_user.effective_water_goal %>
      <div class="target-row">
        <span class="target-label">Water</span>
        <div class="target-progress">
          <div class="target-bar target-bar-water" style="width: <%= water_goal > 0 ? [((water_today / water_goal) * 100), 100].min : 0 %>%"></div>
        </div>
        <span class="target-numbers"><%= water_today.round(1) %> / <%= water_goal %> cups</span>
      </div>
      <% prayer_today = @activities.where(category: "prayer_meditation").sum(:value) %>
      <% prayer_goal = current_user.prayer_goal_minutes || 15 %>
      <div class="target-row">
        <span class="target-label">Prayer</span>
        <div class="target-progress">
          <div class="target-bar target-bar-prayer" style="width: <%= prayer_goal > 0 ? [((prayer_today / prayer_goal.to_f) * 100), 100].min : 0 %>%"></div>
        </div>
        <span class="target-numbers"><%= prayer_today.round(0) %> / <%= prayer_goal %> min</span>
      </div>
    </div>
  <% end %>

  <%= link_to "＋ Log Activity", new_activity_path(date: @date), class: "btn btn-primary btn-block" %>

  <% if @prev_activities.any? %>
    <div class="prev-day-tags">
      <h4 class="prev-day-title">Repeat from <%= (@date - 1.day) == Date.today ? "today" : (@date - 1.day).strftime("%A") %></h4>
      <div class="tag-list">
        <% @prev_activities.each do |prev| %>
          <%= button_to activity_tag_label(prev),
              duplicate_activity_path(prev, date: @date),
              method: :post,
              class: "tag-btn" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @activities.any? %>
    <div class="activity-groups">
      <% @grouped.each do |category, activities| %>
        <section class="category-group">
          <h3 class="category-title">
            <span class="category-icon"><%= category_icon(category) %></span>
            <%= category_label(category) %>
            <span class="category-count">(<%= activities.size %>)</span>
          </h3>

          <% activities.each do |activity| %>
            <div class="activity-card">
              <% if activity.photos.any? %>
                <div class="activity-photo <%= 'photo-grid' if activity.photos.count > 1 %>">
                  <% activity.photos.each do |photo| %>
                    <%= image_tag photo, alt: activity.category %>
                  <% end %>
                </div>
              <% end %>

              <div class="activity-details">
                <% if activity.display_value %>
                  <span class="activity-value"><%= activity.display_value %></span>
                <% end %>
                <% if activity.calories.present? && activity.calories > 0 %>
                  <span class="activity-calories <%= activity.intake? ? 'cal-in' : 'cal-out' %>">
                    <%= activity.intake? ? "+" : "-" %><%= activity.calories %> cal
                  </span>
                <% end %>
                <% if activity.notes.present? %>
                  <p class="activity-notes"><%= activity.notes %></p>
                <% end %>
                <span class="activity-time"><%= activity.created_at.in_time_zone.strftime("%-I:%M %p") %></span>
              </div>

              <div class="activity-actions">
                <%= button_to "Repeat", duplicate_activity_path(activity), method: :post, class: "btn btn-sm btn-outline" %>
                <%= link_to "Edit", edit_activity_path(activity), class: "btn btn-sm" %>
                <%= button_to "Delete", activity_path(activity), method: :delete,
                    class: "btn btn-sm btn-danger",
                    data: { turbo_confirm: "Remove this entry?" } %>
              </div>
            </div>
          <% end %>
        </section>
      <% end %>
    </div>
  <% else %>
    <div class="empty-state">
      <p>No activities logged for this day.</p>
      <p>Tap the button above to start tracking!</p>
    </div>
  <% end %>
</div>
