<div class="container">
  <header class="app-header">
    <h1>HealthMe</h1>
    <p class="tagline">Your daily health tracker</p>
  </header>

  <nav class="date-nav">
    <%= link_to "â† Prev", activities_path(date: @date - 1.day), class: "btn btn-outline" %>
    <div class="date-display">
      <h2><%= @date == Time.zone.today ? "Today" : @date.strftime("%A") %></h2>
      <span class="date-full"><%= @date.strftime("%B %-d, %Y") %></span>
    </div>
    <%= link_to "Next â†’", activities_path(date: @date + 1.day), class: "btn btn-outline" %>
  </nav>

  <% if notice.present? %>
    <div class="flash-notice"><%= notice %></div>
  <% end %>

  <div data-controller="fasting-reminder"
       data-fasting-reminder-start-hour-value="<%= current_user.effective_fasting_start_hour %>"
       data-fasting-reminder-today-value="<%= @date == Time.zone.today %>">
    <div class="fasting-banner" data-fasting-reminder-target="banner"
         style="<%= 'display:none' unless @date == Time.zone.today && current_user.fasting_active? %>">
      <span class="fasting-icon">ðŸŒ™</span>
      <div class="fasting-text">
        <strong>Fasting time</strong> â€” Only water and non-caloric fluids from now.
      </div>
      <button class="btn btn-sm btn-outline" data-action="fasting-reminder#enableNotifications" style="margin-left:auto; white-space:nowrap;">Enable Alerts</button>
    </div>
  </div>

  <% total_burned = @calories_burned + (@recommendations ? @recommendations[:daily_burn] : 0) %>
  <% total_net = @calories_in - total_burned %>

  <div class="calorie-summary">
    <div class="calorie-card calorie-in">
      <span class="calorie-label">Consumed</span>
      <span class="calorie-number"><%= number_with_delimiter(@calories_in) %></span>
      <span class="calorie-unit">cal</span>
    </div>
    <div class="calorie-card calorie-out">
      <span class="calorie-label">Burned</span>
      <span class="calorie-number"><%= number_with_delimiter(total_burned) %></span>
      <span class="calorie-unit">cal</span>
      <% if @recommendations %>
        <span class="calorie-breakdown"><%= number_with_delimiter(@recommendations[:daily_burn]) %> base + <%= @calories_burned %> exercise</span>
      <% end %>
    </div>
    <div class="calorie-card calorie-net <%= total_net >= 0 ? 'calorie-positive' : 'calorie-negative' %>">
      <span class="calorie-label">Net</span>
      <span class="calorie-number"><%= total_net >= 0 ? "+" : "" %><%= number_with_delimiter(total_net) %></span>
      <span class="calorie-unit">cal</span>
    </div>
  </div>

  <% if @recommendations %>
    <div class="daily-targets">
      <div class="target-row">
        <span class="target-label">Calories</span>
        <div class="target-progress">
          <div class="target-bar" style="width: <%= [(@calories_in.to_f / @recommendations[:daily_calories] * 100), 100].min %>%"></div>
        </div>
        <span class="target-numbers"><%= @calories_in %> / <%= number_with_delimiter(@recommendations[:daily_calories]) %></span>
      </div>
      <% if @recommendations[:protein_g] && @recommendations[:protein_g] > 0 %>
        <div class="target-row">
          <span class="target-label">Protein</span>
          <div class="target-progress">
            <div class="target-bar target-bar-protein" style="width: <%= [(@macros[:protein_g] / @recommendations[:protein_g].to_f * 100), 100].min %>%"></div>
          </div>
          <span class="target-numbers"><%= @macros[:protein_g].round(0) %> / <%= @recommendations[:protein_g] %>g</span>
        </div>
        <div class="target-row">
          <span class="target-label">Carbs</span>
          <div class="target-progress">
            <div class="target-bar target-bar-carbs" style="width: <%= [(@macros[:carbs_g] / @recommendations[:carbs_g].to_f * 100), 100].min %>%"></div>
          </div>
          <span class="target-numbers"><%= @macros[:carbs_g].round(0) %> / <%= @recommendations[:carbs_g] %>g</span>
        </div>
        <div class="target-row">
          <span class="target-label">Fat</span>
          <div class="target-progress">
            <div class="target-bar target-bar-fat" style="width: <%= [(@macros[:fat_g] / @recommendations[:fat_g].to_f * 100), 100].min %>%"></div>
          </div>
          <span class="target-numbers"><%= @macros[:fat_g].round(0) %> / <%= @recommendations[:fat_g] %>g</span>
        </div>
      <% end %>
      <% exercise_goal = @recommendations[:activity_burn].to_f %>
      <% walk_cal = @activities.where(category: "walk").sum(:calories) %>
      <% run_cal = @activities.where(category: "run").sum(:calories) %>
      <% weights_cal = @activities.where(category: "weights").sum(:calories) %>
      <% yoga_cal = @activities.where(category: "yoga").sum(:calories) %>
      <div class="target-row">
        <span class="target-label">Exercise</span>
        <div class="target-progress target-stacked">
          <% if exercise_goal > 0 %>
            <div class="target-segment segment-walk" style="width: <%= [(walk_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-run" style="width: <%= [(run_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-weights" style="width: <%= [(weights_cal / exercise_goal * 100), 100].min %>%"></div>
            <div class="target-segment segment-yoga" style="width: <%= [(yoga_cal / exercise_goal * 100), 100].min %>%"></div>
          <% end %>
        </div>
        <span class="target-numbers"><%= @calories_burned %> / <%= number_with_delimiter(@recommendations[:activity_burn]) %> cal</span>
      </div>
      <div class="target-detail">
        Goal = daily burn (<%= number_with_delimiter(@recommendations[:tdee]) %>) âˆ’ resting (<%= number_with_delimiter(@recommendations[:bmr]) %>)
      </div>
      <% if @calories_burned > 0 %>
        <div class="exercise-legend">
          <% if walk_cal > 0 %><span class="legend-item"><span class="legend-dot legend-walk"></span>Walk <%= walk_cal %></span><% end %>
          <% if run_cal > 0 %><span class="legend-item"><span class="legend-dot legend-run"></span>Run <%= run_cal %></span><% end %>
          <% if weights_cal > 0 %><span class="legend-item"><span class="legend-dot legend-weights"></span>Weights <%= weights_cal %></span><% end %>
          <% if yoga_cal > 0 %><span class="legend-item"><span class="legend-dot legend-yoga"></span>Yoga <%= yoga_cal %></span><% end %>
        </div>
      <% end %>
      <% water_today = @activities.where(category: "water").sum(:value) %>
      <% water_goal = current_user.effective_water_goal %>
      <div class="target-row">
        <span class="target-label">Water</span>
        <div class="target-progress">
          <div class="target-bar target-bar-water" style="width: <%= water_goal > 0 ? [((water_today / water_goal) * 100), 100].min : 0 %>%"></div>
        </div>
        <span class="target-numbers"><%= water_today.round(1) %> / <%= water_goal %> cups</span>
      </div>
      <% prayer_today = @activities.where(category: "prayer_meditation").sum(:value) %>
      <% prayer_goal = current_user.prayer_goal_minutes || 15 %>
      <div class="target-row">
        <span class="target-label">Prayer</span>
        <div class="target-progress">
          <div class="target-bar target-bar-prayer" style="width: <%= prayer_goal > 0 ? [((prayer_today / prayer_goal.to_f) * 100), 100].min : 0 %>%"></div>
        </div>
        <span class="target-numbers"><%= prayer_today.round(0) %> / <%= prayer_goal %> min</span>
      </div>
    </div>
  <% end %>

  <%= link_to "ï¼‹ Log Activity", new_activity_path(date: @date), class: "btn btn-primary btn-block" %>

  <% if @prev_activities.any? %>
    <div class="prev-day-tags">
      <h4 class="prev-day-title">Repeat from <%= (@date - 1.day) == Time.zone.today ? "today" : (@date - 1.day).strftime("%A") %></h4>
      <div class="tag-list">
        <% @prev_activities.each do |prev| %>
          <%= button_to activity_tag_label(prev),
              duplicate_activity_path(prev, date: @date),
              method: :post,
              class: "tag-btn" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @activities.any? %>
    <div data-controller="sort-toggle">
      <div class="sort-toggle-bar">
        <button class="btn btn-sm btn-outline" data-sort-toggle-target="btn" data-action="sort-toggle#toggle">Timeline</button>
      </div>

      <div class="activity-groups" data-sort-toggle-target="grouped">
        <% @grouped.each do |category, activities| %>
          <details class="category-group">
            <summary class="category-title">
              <span class="category-icon"><%= category_icon(category) %></span>
              <%= category_label(category) %>
              <span class="category-count">(<%= activities.size %>)</span>
              <% unless category.in?(%w[medication sleep water prayer_meditation body_weight]) %>
                <% cat_cal = activities.sum { |a| a.calories.to_i } %>
                <% if cat_cal > 0 %>
                  <span class="category-cal"><%= activities.first&.intake? ? "+" : "-" %><%= cat_cal %> cal</span>
                <% end %>
              <% end %>
              <span class="category-chevron"></span>
            </summary>
            <div class="category-activities">
              <% activities.each do |activity| %>
                <%= render partial: "activities/activity_card", locals: { activity: activity } %>
              <% end %>
            </div>
          </details>
        <% end %>
      </div>

      <div class="activity-groups" data-sort-toggle-target="timeline" style="display: none;">
        <% @activities.sort_by { |a| [a.category == "water" ? 1 : 0, a.created_at.to_f] }.each do |activity| %>
          <div class="timeline-entry">
            <span class="timeline-icon"><%= category_icon(activity.category) %></span>
            <%= render partial: "activities/activity_card", locals: { activity: activity } %>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="empty-state">
      <p>No activities logged for this day.</p>
      <p>Tap the button above to start tracking!</p>
    </div>
  <% end %>

  <% if @activities.any? && current_user.profile_complete? %>
    <div class="diet-tips-section" data-controller="diet-tips" data-diet-tips-url-value="<%= diet_tips_activities_path(date: @date) %>">
      <button class="btn btn-outline btn-block" data-diet-tips-target="button" data-action="diet-tips#load">
        Get Daily Tips
      </button>
      <div data-diet-tips-target="content" style="display: none;"></div>
    </div>
  <% end %>
</div>
