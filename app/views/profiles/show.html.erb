<div class="container">
  <header class="app-header">
    <h1>Your Profile</h1>
  </header>

  <% if notice.present? %>
    <div class="flash-notice"><%= notice %></div>
  <% end %>

  <% if @user.profile_complete? && @recommendations %>
    <section class="recommendations-card">
      <h3 class="section-title">Daily Recommendations</h3>
      <p class="goal-badge"><%= @recommendations[:goal_label] %></p>

      <%
        burn_activities = @today_activities.select(&:burn?)
        intake_activities = @today_activities.select(&:intake?)
        water_activities = @today_activities.select { |a| a.category == "water" }
      %>
      <div class="rec-grid">
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Daily Burn</span>
          <span class="rec-value"><%= number_with_delimiter(@recommendations[:daily_burn]) %></span>
          <span class="rec-unit">cal/day</span>
          <% burn_pct = @recommendations[:daily_burn] > 0 ? [(@today[:calories_burned].to_f / @recommendations[:daily_burn] * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-burn" style="width: <%= burn_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:calories_burned] %> burned</span>
          <% if burn_activities.any? %>
            <div class="rec-tooltip">
              <% burn_activities.sort_by { |a| -a.calories.to_f }.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> <%= a.notes.presence || category_label(a.category) %></span><span><%= a.calories.to_i %> cal</span></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Calorie Target</span>
          <span class="rec-value"><%= number_with_delimiter(@recommendations[:daily_calories]) %></span>
          <span class="rec-unit">cal/day</span>
          <% cal_pct = @recommendations[:daily_calories] > 0 ? [(@today[:calories_in].to_f / @recommendations[:daily_calories] * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-cal" style="width: <%= cal_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:calories_in] %> eaten</span>
          <% if intake_activities.select { |a| a.calories.to_f > 0 }.any? %>
            <div class="rec-tooltip">
              <% intake_activities.select { |a| a.calories.to_f > 0 }.sort_by { |a| -a.calories.to_f }.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> <%= a.notes.presence&.truncate(20) || category_label(a.category) %></span><span><%= a.calories.to_i %> cal</span></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Water</span>
          <span class="rec-value"><%= @user.effective_water_goal %></span>
          <span class="rec-unit">cups/day</span>
          <% water_goal = @user.effective_water_goal.to_f; water_pct = water_goal > 0 ? [(@today[:water] / water_goal * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-water" style="width: <%= water_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:water] %> cups</span>
          <% if water_activities.any? %>
            <div class="rec-tooltip">
              <% water_activities.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> Water</span><span><%= a.display_value %></span></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Protein</span>
          <span class="rec-value"><%= @recommendations[:protein_g] %>g</span>
          <% pro_pct = @recommendations[:protein_g] > 0 ? [(@today[:protein_g] / @recommendations[:protein_g].to_f * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-protein" style="width: <%= pro_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:protein_g] %>g today</span>
          <% protein_items = intake_activities.select { |a| a.protein_g.to_f > 0 } %>
          <% if protein_items.any? %>
            <div class="rec-tooltip">
              <% protein_items.sort_by { |a| -a.protein_g.to_f }.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> <%= a.notes.presence&.truncate(20) || category_label(a.category) %></span><span><%= a.protein_g %>g</span></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Carbs</span>
          <span class="rec-value"><%= @recommendations[:carbs_g] %>g</span>
          <% carbs_pct = @recommendations[:carbs_g] > 0 ? [(@today[:carbs_g] / @recommendations[:carbs_g].to_f * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-carbs" style="width: <%= carbs_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:carbs_g] %>g today</span>
          <% carb_items = intake_activities.select { |a| a.carbs_g.to_f > 0 } %>
          <% if carb_items.any? %>
            <div class="rec-tooltip">
              <% carb_items.sort_by { |a| -a.carbs_g.to_f }.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> <%= a.notes.presence&.truncate(20) || category_label(a.category) %></span><span><%= a.carbs_g %>g</span></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="rec-item rec-has-tip">
          <span class="rec-label">Fat</span>
          <span class="rec-value"><%= @recommendations[:fat_g] %>g</span>
          <% fat_pct = @recommendations[:fat_g] > 0 ? [(@today[:fat_g] / @recommendations[:fat_g].to_f * 100), 100].min : 0 %>
          <div class="rec-progress"><div class="rec-bar rec-bar-fat" style="width: <%= fat_pct %>%"></div></div>
          <span class="rec-actual"><%= @today[:fat_g] %>g today</span>
          <% fat_items = intake_activities.select { |a| a.fat_g.to_f > 0 } %>
          <% if fat_items.any? %>
            <div class="rec-tooltip">
              <% fat_items.sort_by { |a| -a.fat_g.to_f }.each do |a| %>
                <div class="rec-tip-row"><span><%= category_icon(a.category) %> <%= a.notes.presence&.truncate(20) || category_label(a.category) %></span><span><%= a.fat_g %>g</span></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="rec-details">
        <p><strong>BMI:</strong> <%= @recommendations[:bmi] %> (<%= @recommendations[:bmi_category] %>)</p>
        <p><strong>Resting burn (BMR):</strong> <%= number_with_delimiter(@recommendations[:resting_burn]) %> cal/day</p>
        <p><strong>Activity burn:</strong> <%= number_with_delimiter(@recommendations[:activity_burn]) %> cal/day</p>
        <p><strong>Total daily burn (TDEE):</strong> <%= number_with_delimiter(@recommendations[:tdee]) %> cal/day</p>
      </div>
    </section>
  <% else %>
    <div class="empty-state">
      <p>Complete your profile to see personalized recommendations.</p>
      <p>We need at least your weight, height, date of birth, and sex.</p>
    </div>
  <% end %>

  <section class="profile-details-card">
    <h3 class="section-title">Profile Details</h3>

    <dl class="profile-dl">
      <% if @user.display_name.present? %>
        <dt>Name</dt>
        <dd><%= @user.display_name %></dd>
      <% end %>
      <% if @user.date_of_birth.present? %>
        <dt>Age</dt>
        <dd><%= @user.age %> years old</dd>
      <% end %>
      <% if @user.sex.present? %>
        <dt>Sex</dt>
        <dd><%= @user.sex.capitalize %></dd>
      <% end %>
      <% if @user.weight.present? %>
        <dt>Weight</dt>
        <dd><%= @user.weight %> lbs</dd>
      <% end %>
      <% if @user.height.present? %>
        <dt>Height</dt>
        <dd><%= format_height(@user.height) %></dd>
      <% end %>
      <% if @user.blood_pressure_systolic.present? %>
        <dt>Blood Pressure</dt>
        <dd><%= @user.blood_pressure_systolic %>/<%= @user.blood_pressure_diastolic %> mmHg</dd>
      <% end %>
      <% if @user.activity_level.present? %>
        <dt>Activity Level</dt>
        <dd><%= @user.activity_level.humanize %></dd>
      <% end %>
      <% if @user.goal.present? %>
        <dt>Goal</dt>
        <dd><%= @user.goal.humanize %></dd>
      <% end %>
      <% if @user.health_concerns.present? %>
        <dt>Health Concerns</dt>
        <dd><%= @user.health_concerns %></dd>
      <% end %>
    </dl>
  </section>

  <%# App Security section â€” only visible inside Capacitor native shell %>
  <section class="profile-details-card biometric-section" data-biometric-lock-target="toggleSection" style="display: none;">
    <h3 class="section-title">App Security</h3>
    <div class="biometric-toggle-row">
      <div>
        <strong>Face ID / Touch ID Lock</strong>
        <p class="biometric-hint">Require biometric authentication when opening the app</p>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" data-biometric-lock-target="toggle" data-action="biometric-lock#toggleBiometric">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </section>

  <%= link_to "Edit Profile", edit_profile_path, class: "btn btn-primary btn-block" %>
</div>
